<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pesan Catering - Catering Premium</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .page-title {
      text-align: center;
      color: #ff6b35;
      font-size: 2.5em;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 40px;
    }

    .form-group {
      margin-bottom: 25px;
    }

    label {
      display: block;
      color: #333;
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 1.1em;
    }

    .required {
      color: #ff6b35;
    }

    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="date"],
    input[type="time"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #ffe0b2;
      border-radius: 8px;
      font-size: 1em;
      font-family: inherit;
      transition: all 0.3s;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #ff6b35;
      box-shadow: 0 0 10px rgba(255, 107, 53, 0.2);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    .checkbox-group {
      margin-top: 15px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      padding: 10px;
      background: #fff4e6;
      border-radius: 8px;
      transition: all 0.3s;
    }

    .checkbox-item:hover {
      background: #ffe0b2;
    }

    .checkbox-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      cursor: pointer;
    }

    .checkbox-item label {
      margin: 0;
      font-weight: normal;
      cursor: pointer;
    }

    .info-box {
      background: #fff4e6;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #ff6b35;
      margin-bottom: 20px;
      color: #666;
    }

    .btn-submit {
      background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
      color: white;
      padding: 15px 40px;
      border: none;
      border-radius: 30px;
      font-size: 1.2em;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      transition: all 0.3s;
      box-shadow: 0 5px 15px rgba(255, 107, 53, 0.3);
    }

    .btn-submit:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(255, 107, 53, 0.4);
    }

    .btn-submit:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .btn-reset {
      background: #dc3545;
      color: white;
      padding: 12px 30px;
      border: none;
      border-radius: 25px;
      font-size: 1em;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
      transition: all 0.3s;
    }

    .btn-reset:hover {
      background: #c82333;
    }

    .success-message {
      background: #28a745;
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
      text-align: center;
      display: none;
    }

    .error-message {
      background: #dc3545;
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
      display: none;
    }

    .order-summary {
      background: linear-gradient(135deg, #fff4e6 0%, #ffe0b2 100%);
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }

    .order-summary h3 {
      color: #ff6b35;
      margin-bottom: 15px;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #ddd;
    }

    .summary-total {
      font-size: 1.3em;
      font-weight: bold;
      color: #ff6b35;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px solid #ff6b35;
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }

      .page-title {
        font-size: 1.8em;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <h1 class="page-title">Detail Pesanan</h1>
  <p class="subtitle">Lengkapi formulir di bawah ini untuk memesan catering</p>

  <form id="orderForm">
    <!-- Data Pemesan -->
    <div class="form-group">
      <label>Nama Lengkap <span class="required">*</span></label>
      <input type="text" id="nama" name="nama" required placeholder="Masukkan nama lengkap Anda">
    </div>

    <div class="form-group">
      <label>Nomor Telepon <span class="required">*</span></label>
      <input type="tel" id="telepon" name="telepon" required placeholder="08xxxxxxxxxx">
    </div>

    <div class="form-group">
      <label>Email</label>
      <input type="email" id="email" name="email" placeholder="email@example.com">
    </div>

    <div class="form-group">
      <label>Alamat Pengiriman <span class="required">*</span></label>
      <textarea id="alamat" name="alamat" required placeholder="Masukkan alamat lengkap pengiriman"></textarea>
    </div>

    <!-- Detail Pesanan -->
    <div class="form-group">
      <label>Tipe Menu <span class="required">*</span></label>
      <select id="tipeMenu" name="tipeMenu" required>
        <option value="">-- Pilih Tipe Menu --</option>
        <option value="prasmanan">Prasmanan</option>
        <option value="nasi-box">Nasi Box</option>
        <option value="custom">Custom Menu</option>
      </select>
    </div>

    <div class="form-group" id="paketGroup" style="display: none;">
      <label>Pilih Paket</label>
      <select id="paket" name="paket">
        <option value="">-- Pilih Paket (Opsional) --</option>
      </select>
    </div>

    <div class="form-group">
      <label>Jumlah Porsi <span class="required">*</span></label>
      <input type="number" id="jumlahPorsi" name="jumlahPorsi" required min="20" placeholder="Minimum order 20 porsi">
      <small style="color: #666;">Minimum order 20 porsi</small>
    </div>

    <div class="form-group">
      <label>Tanggal Acara <span class="required">*</span></label>
      <input type="date" id="tanggalAcara" name="tanggalAcara" required>
    </div>

    <div class="form-group">
      <label>Waktu Acara <span class="required">*</span></label>
      <input type="time" id="waktuAcara" name="waktuAcara" required>
    </div>

    <div class="form-group">
      <label>Permintaan Khusus</label>
      <textarea id="permintaan" name="permintaan" placeholder="Contoh: tidak pakai sambal pedas, tambahkan dessert, dll"></textarea>
    </div>

    <!-- Layanan Tambahan -->
    <div class="form-group">
      <label>Layanan Tambahan</label>
      <div class="checkbox-group">
        <div class="checkbox-item">
          <input type="checkbox" id="pramusaji" name="pramusaji" value="pramusaji">
          <label for="pramusaji">Saya membutuhkan jasa pramusaji (+Rp 500.000)</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="peralatan" name="peralatan" value="peralatan">
          <label for="peralatan">Saya membutuhkan peralatan makan (+Rp 300.000)</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="syarat" name="syarat" value="syarat" required>
          <label for="syarat">Saya setuju dengan syarat dan ketentuan yang berlaku <span class="required">*</span></label>
        </div>
      </div>
    </div>

    <div class="info-box">
      <strong>‚ÑπÔ∏è Informasi Penting:</strong><br>
      ‚Ä¢ Minimal pemesanan H-3 dari tanggal acara<br>
      ‚Ä¢ DP 50% setelah konfirmasi pesanan<br>
      ‚Ä¢ Pelunasan dilakukan H-1 acara
    </div>

    <!-- Order Summary -->
    <div class="order-summary" id="orderSummary" style="display: none;">
      <h3>üìã Ringkasan Pesanan</h3>
      <div id="summaryContent"></div>
    </div>

    <div class="error-message" id="errorMessage"></div>

    <button type="submit" class="btn-submit" id="submitBtn">
      üìß Kirim Pesanan
    </button>

    <button type="button" class="btn-reset" onclick="resetForm()">
      üîÑ Reset Form
    </button>

    <div class="success-message" id="successMessage">
      ‚úÖ Pesanan berhasil dikirim! Kami akan segera menghubungi Anda.
    </div>
  </form>
</div>

<script>
  // Data paket
  const paketData = {
    prasmanan: [
      { name: 'Paket 1 - 100 Porsi', price: 1500000 },
      { name: 'Paket 2 - 300 Porsi', price: 4000000 },
      { name: 'Paket 3 - 500 Porsi', price: 6500000 }
    ],
    'nasi-box': [
      { name: 'Paket 1 - Ayam Goreng', price: 25000 },
      { name: 'Paket 2 - Ayam Bakar', price: 28000 },
      { name: 'Paket 3 - Nugget', price: 22000 },
      { name: 'Paket 4 - Daging Rendang', price: 35000 }
    ]
  };

  // Update pilihan paket berdasarkan tipe menu
  function updatePaketOptions() {
    const tipeMenu = document.getElementById('tipeMenu').value;
    const paketGroup = document.getElementById('paketGroup');
    const paketSelect = document.getElementById('paket');
    
    if (tipeMenu && tipeMenu !== 'custom') {
      paketGroup.style.display = 'block';
      paketSelect.innerHTML = '<option value="">-- Pilih Paket (Opsional) --</option>';
      
      if (paketData[tipeMenu]) {
        paketData[tipeMenu].forEach(paket => {
          const option = document.createElement('option');
          option.value = JSON.stringify(paket);
          option.textContent = `${paket.name} - Rp ${paket.price.toLocaleString('id-ID')}`;
          paketSelect.appendChild(option);
        });
      }
    } else {
      paketGroup.style.display = 'none';
    }
    
    calculateTotal();
  }

  // Hitung total estimasi
  function calculateTotal() {
    const tipeMenu = document.getElementById('tipeMenu').value;
    const paketValue = document.getElementById('paket').value;
    const jumlahPorsi = parseInt(document.getElementById('jumlahPorsi').value) || 0;
    const pramusaji = document.getElementById('pramusaji').checked;
    const peralatan = document.getElementById('peralatan').checked;
    
    if (!tipeMenu || jumlahPorsi < 20) {
      document.getElementById('orderSummary').style.display = 'none';
      return;
    }
    
    let total = 0;
    let summaryHTML = '';
    
    if (paketValue) {
      const paket = JSON.parse(paketValue);
      total = paket.price * (tipeMenu === 'nasi-box' ? jumlahPorsi : 1);
      summaryHTML += `
        <div class="summary-item">
          <span>${paket.name}</span>
          <span>Rp ${total.toLocaleString('id-ID')}</span>
        </div>
      `;
    } else {
      total = jumlahPorsi * 30000; // Estimasi harga per porsi
      summaryHTML += `
        <div class="summary-item">
          <span>${tipeMenu} (${jumlahPorsi} porsi)</span>
          <span>Rp ${total.toLocaleString('id-ID')}</span>
        </div>
      `;
    }
    
    if (pramusaji) {
      total += 500000;
      summaryHTML += `
        <div class="summary-item">
          <span>Jasa Pramusaji</span>
          <span>Rp 500.000</span>
        </div>
      `;
    }
    
    if (peralatan) {
      total += 300000;
      summaryHTML += `
        <div class="summary-item">
          <span>Peralatan Makan</span>
          <span>Rp 300.000</span>
        </div>
      `;
    }
    
    summaryHTML += `
      <div class="summary-total">
        <div class="summary-item">
          <span>TOTAL ESTIMASI:</span>
          <span>Rp ${total.toLocaleString('id-ID')}</span>
        </div>
      </div>
    `;
    
    document.getElementById('summaryContent').innerHTML = summaryHTML;
    document.getElementById('orderSummary').style.display = 'block';
  }

  // Handle form submission dengan error handling yang lebih baik
  document.getElementById('orderForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    
    // Reset messages
    errorMessage.style.display = 'none';
    successMessage.style.display = 'none';
    
    // Validasi
    const jumlahPorsi = parseInt(document.getElementById('jumlahPorsi').value);
    if (jumlahPorsi < 20) {
      errorMessage.textContent = '‚ùå Minimum pemesanan adalah 20 porsi!';
      errorMessage.style.display = 'block';
      return;
    }
    
    const syarat = document.getElementById('syarat').checked;
    if (!syarat) {
      errorMessage.textContent = '‚ùå Anda harus menyetujui syarat dan ketentuan!';
      errorMessage.style.display = 'block';
      return;
    }
    
    // Disable button
    submitBtn.disabled = true;
    submitBtn.textContent = '‚è≥ Mengirim...';
    
    // Kumpulkan data
    const orderData = {
      orderId: 'ORD-' + Date.now(),
      orderDate: new Date().toISOString(),
      nama: document.getElementById('nama').value,
      telepon: document.getElementById('telepon').value,
      email: document.getElementById('email').value,
      alamat: document.getElementById('alamat').value,
      tipeMenu: document.getElementById('tipeMenu').value,
      paket: document.getElementById('paket').value,
      jumlahPorsi: jumlahPorsi,
      tanggalAcara: document.getElementById('tanggalAcara').value,
      waktuAcara: document.getElementById('waktuAcara').value,
      permintaan: document.getElementById('permintaan').value,
      pramusaji: document.getElementById('pramusaji').checked,
      peralatan: document.getElementById('peralatan').checked,
      estimasiTotal: document.getElementById('summaryContent').textContent
    };
    
    // Format pesan WhatsApp (dibuat di awal)
    let waMessage = `üéâ *PESANAN CATERING BARU*\n\n`;
    waMessage += `üìã *Order ID:* ${orderData.orderId}\n`;
    waMessage += `üë§ *Nama:* ${orderData.nama}\n`;
    waMessage += `üì± *Telepon:* ${orderData.telepon}\n`;
    if (orderData.email) waMessage += `üìß *Email:* ${orderData.email}\n`;
    waMessage += `üìç *Alamat:* ${orderData.alamat}\n\n`;
    waMessage += `üçΩÔ∏è *Detail Pesanan:*\n`;
    waMessage += `‚Ä¢ Tipe: ${orderData.tipeMenu}\n`;
    waMessage += `‚Ä¢ Jumlah: ${orderData.jumlahPorsi} porsi\n`;
    waMessage += `‚Ä¢ Tanggal: ${orderData.tanggalAcara}\n`;
    waMessage += `‚Ä¢ Waktu: ${orderData.waktuAcara}\n`;
    if (orderData.pramusaji) waMessage += `‚Ä¢ Pramusaji: Ya\n`;
    if (orderData.peralatan) waMessage += `‚Ä¢ Peralatan: Ya\n`;
    if (orderData.permintaan) waMessage += `\nüìù *Permintaan Khusus:*\n${orderData.permintaan}\n`;
    
    const waLink = `https://wa.me/6281234567890?text=${encodeURIComponent(waMessage)}`;
    
    // Coba simpan ke storage dengan retry logic dan fallback
    let storageSaved = false;
    let retryCount = 0;
    const maxRetries = 3;
    
    while (!storageSaved && retryCount < maxRetries) {
      try {
        retryCount++;
        
        // Coba ambil data existing
        let orders = [];
        try {
          const existingOrders = await window.storage.get('catering-orders');
          if (existingOrders && existingOrders.value) {
            orders = JSON.parse(existingOrders.value);
            // Validasi array
            if (!Array.isArray(orders)) {
              orders = [];
            }
          }
        } catch (getError) {
          console.warn('Could not retrieve existing orders, starting fresh:', getError);
          orders = [];
        }
        
        // Tambah order baru
        orders.push(orderData);
        
        // Batasi jumlah order yang disimpan (max 100 untuk menghindari data terlalu besar)
        if (orders.length > 100) {
          orders = orders.slice(-100);
        }
        
        // Simpan kembali
        await window.storage.set('catering-orders', JSON.stringify(orders));
        storageSaved = true;
        console.log('‚úÖ Order saved successfully to storage!');
        
      } catch (error) {
        console.warn(`‚ö†Ô∏è Storage attempt ${retryCount} failed:`, error);
        if (retryCount >= maxRetries) {
          console.error('‚ùå Failed to save to storage after multiple attempts, proceeding without storage');
        } else {
          // Tunggu sebentar sebelum retry
          await new Promise(resolve => setTimeout(resolve, 500));
        }
      }
    }
    
    // Tampilkan success message (dengan atau tanpa storage)
    if (storageSaved) {
      successMessage.textContent = '‚úÖ Pesanan berhasil dikirim dan tersimpan! Kami akan segera menghubungi Anda.';
    } else {
      successMessage.textContent = '‚úÖ Pesanan berhasil dikirim! Kami akan segera menghubungi Anda.';
    }
    successMessage.style.display = 'block';
    
    // Redirect ke WhatsApp setelah 2 detik
    setTimeout(() => {
      window.open(waLink, 'https://wa.me/085758534639');
      resetForm();
    }, 2000);
  });

  // Reset form
  function resetForm() {
    document.getElementById('orderForm').reset();
    document.getElementById('orderSummary').style.display = 'none';
    document.getElementById('paketGroup').style.display = 'none';
    document.getElementById('successMessage').style.display = 'none';
    document.getElementById('errorMessage').style.display = 'none';
    document.getElementById('submitBtn').disabled = false;
    document.getElementById('submitBtn').textContent = 'üìß Kirim Pesanan';
  }

  // Set minimum date to today + 3 days (H-3 dari tanggal acara)
  const today = new Date();
  today.setDate(today.getDate() + 3);
  const minDate = today.toISOString().split('T')[0];
  document.getElementById('tanggalAcara').setAttribute('min', minDate);

  // Add event listeners
  document.getElementById('tipeMenu').addEventListener('change', updatePaketOptions);
  document.getElementById('jumlahPorsi').addEventListener('input', calculateTotal);
  document.getElementById('pramusaji').addEventListener('change', calculateTotal);
  document.getElementById('peralatan').addEventListener('change', calculateTotal);
  document.getElementById('paket').addEventListener('change', calculateTotal);
</script>

</body>
</html>